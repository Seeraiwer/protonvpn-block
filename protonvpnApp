#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

DEBUG_FILE="/tmp/protonvpn_debug.log"
touch "$DEBUG_FILE"
echo "DEBUG: Script started at $(date)" > "$DEBUG_FILE"

# 1) DÃ©tecter toute interface VPN active (wireguard ou tun, Proton ou autre)
vpn_line=$(
  nmcli -t -f NAME,TYPE,DEVICE connection show --active \
    | grep -iE 'proton|wireguard|tun' | head -n 1 || true
)
echo "DEBUG: Active connections list:" >> "$DEBUG_FILE"
nmcli -t -f NAME,TYPE,DEVICE connection show --active >> "$DEBUG_FILE" 2>>"$DEBUG_FILE"
echo "DEBUG: Selected vpn_line='$vpn_line'" >> "$DEBUG_FILE"

if [[ -z "$vpn_line" ]]; then
  echo "âš ï¸ No VPN âš ï¸"
  echo                                    # nÃ©cesÂ­saire pour i3blocks
  echo "DEBUG: No vpn_line detected, exiting." >> "$DEBUG_FILE"
  exit 0
fi

# Extraction du nom et de lâ€™interface
VPN_NAME=${vpn_line%%:*}
VPN_IFACE=${vpn_line##*:}
echo "DEBUG: VPN_NAME='$VPN_NAME', VPN_IFACE='$VPN_IFACE'" >> "$DEBUG_FILE"

# 2) RÃ©cupÃ©rer lâ€™IP publique rÃ©elle (via ifconfig.me)
PUB_IP=$(curl -s --max-time 2 https://ifconfig.me || echo "")
echo "DEBUG: PUB_IP(ifconfig.me)='$PUB_IP'" >> "$DEBUG_FILE"

if [[ -z "$PUB_IP" ]]; then
  echo "âš ï¸ No VPN âš ï¸ (no public IP)"
  echo
  echo "DEBUG: PUB_IP is empty, exiting." >> "$DEBUG_FILE"
  exit 0
fi

# 3) RÃ©cupÃ©rer le code pays Ã  partir de cette IP (ipinfo.io)
COUNTRY_CODE=$(curl -s --max-time 2 "https://ipinfo.io/${PUB_IP}/country" \
  | tr -d '\n' | tr 'a-z' 'A-Z' || echo "")
echo "DEBUG: COUNTRY_CODE(ipinfo.io)='$COUNTRY_CODE'" >> "$DEBUG_FILE"

# 4) Extraire le nom du serveur ProtonVPN (si ProtonVPN) ou fallback sur VPN_NAME
LOG=$(tail -n 100 "$HOME/.cache/Proton/VPN/logs/vpn-app.log" 2>/dev/null || echo "")
SERVER_NAME=$(echo "$LOG" | grep -oP 'Server: *[^/ ]+' | awk '{print $2}' | tail -n 1 || echo "")
SERVER_NAME=${SERVER_NAME:-$VPN_NAME}
echo "DEBUG: SERVER_NAME(from logs)='$SERVER_NAME'" >> "$DEBUG_FILE"

# 5) Mapper COUNTRY_CODE â†’ drapeau
get_flag() {
  case "$1" in
    FR) echo "ðŸ‡«ðŸ‡·" ;;
    CH) echo "ðŸ‡¨ðŸ‡­" ;;
    US) echo "ðŸ‡ºðŸ‡¸" ;;
    DE) echo "ðŸ‡©ðŸ‡ª" ;;
    GB|UK) echo "ðŸ‡¬ðŸ‡§" ;;
    NL) echo "ðŸ‡³ðŸ‡±" ;;
    SE) echo "ðŸ‡¸ðŸ‡ª" ;;
    CA) echo "ðŸ‡¨ðŸ‡¦" ;;
    ES) echo "ðŸ‡ªðŸ‡¸" ;;
    IT) echo "ðŸ‡®ðŸ‡¹" ;;
    *) echo "ðŸ³ï¸" ;;  # Drapeau blanc si inconnu
  esac
}

FLAG=$(get_flag "$COUNTRY_CODE")
echo "DEBUG: FLAG(get_flag)='$FLAG'" >> "$DEBUG_FILE"

# 6) Affichage final (deux lignes : texte + ligne vide)
echo "$FLAG $SERVER_NAME ($PUB_IP)"
echo

echo "DEBUG: Script completed at $(date)" >> "$DEBUG_FILE"
