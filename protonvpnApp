#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

LOG_FILE="$HOME/.cache/Proton/VPN/logs/vpn-app.log"
DEBUG_FILE="/tmp/protonvpn_debug.log"

touch "$DEBUG_FILE"
echo "DEBUG: Script started" > "$DEBUG_FILE"

# â€” 1) DÃ©tecte la connexion VPN active â€”
vpn_line=$(
  nmcli -t -f NAME,TYPE,DEVICE connection show --active \
    | grep -iE 'proton|wireguard|tun' | head -n 1
)

echo "DEBUG: Active connections:" >> "$DEBUG_FILE"
nmcli -t -f NAME,TYPE,DEVICE connection show --active >> "$DEBUG_FILE"
echo "DEBUG: Selected VPN line: $vpn_line" >> "$DEBUG_FILE"

if [[ -z "$vpn_line" ]]; then
  echo "âš ï¸ No VPN âš ï¸"
  exit 0
fi

VPN_NAME=${vpn_line%%:*}
_rest=${vpn_line#*:}
VPN_IFACE=${vpn_line##*:}

# â€” 2) RÃ©cupÃ¨re lâ€™IP publique rÃ©elle en sortie (via ifconfig.me) â€”
PUB_IP=$(curl -s --max-time 2 https://ifconfig.me || echo "")
echo "DEBUG: PUB_IP(ifconfig.me)=$PUB_IP" >> "$DEBUG_FILE"

if [[ -z "$PUB_IP" ]]; then
  echo "âš ï¸ No VPN âš ï¸ (Impossible de rÃ©cupÃ©rer lâ€™IP publique)"
  exit 0
fi

# â€” 3) RÃ©cupÃ¨re le code pays depuis ipinfo.io en fonction de cette IP publique â€”
COUNTRY_CODE=$(curl -s --max-time 2 "https://ipinfo.io/${PUB_IP}/country" | tr -d '\n' | tr 'a-z' 'A-Z')
echo "DEBUG: COUNTRY_CODE(ipinfo.io)=$COUNTRY_CODE" >> "$DEBUG_FILE"

# â€” 4) Pour lâ€™affichage du nom du serveur, on lit quand mÃªme les logs ProtonVPN â€”
#     Si impossible, on se rabat sur le nom de la connexion NMCLI
LOG=$(tail -n 100 "$LOG_FILE" 2>/dev/null || echo "")
SERVER_NAME=$(echo "$LOG" | grep -oP 'Server: *[^/ ]+' | awk '{print $2}' | tail -n 1 || echo "")
SERVER_NAME=${SERVER_NAME:-$VPN_NAME}

echo "DEBUG: SERVER_NAME(from logs)=$SERVER_NAME" >> "$DEBUG_FILE"

# â€” 5) Fonction pour renvoyer le drapeau associÃ© au code pays â€”
get_flag() {
  case "$1" in
    FR) echo "ðŸ‡«ðŸ‡·" ;;
    CH) echo "ðŸ‡¨ðŸ‡­" ;;
    US) echo "ðŸ‡ºðŸ‡¸" ;;
    DE) echo "ðŸ‡©ðŸ‡ª" ;;
    GB|UK) echo "ðŸ‡¬ðŸ‡§" ;;
    NL) echo "ðŸ‡³ðŸ‡±" ;;
    SE) echo "ðŸ‡¸ðŸ‡ª" ;;
    CA) echo "ðŸ‡¨ðŸ‡¦" ;;
    ES) echo "ðŸ‡ªðŸ‡¸" ;;
    IT) echo "ðŸ‡®ðŸ‡¹" ;;
    *) echo "ðŸ³ï¸" ;;  # Drapeau blanc si inconnu
  esac
}

FLAG=$(get_flag "$COUNTRY_CODE")
echo "DEBUG: FLAG(get_flag)=$FLAG" >> "$DEBUG_FILE"

# â€” 6) Affichage final â€”
echo "$FLAG $SERVER_NAME ($PUB_IP)"
echo

